# yaml-language-server: $schema=../../../../pipelines/schema/pipeline.schema.json
#
# Pattern: CDC -> State Entity -> SCD Type 1 (current_only) -> Delete Mode: IGNORE
# =================================================================================
# Use Case: CDC feed where deletes should be ignored (soft delete in source)
# - Bronze: CDC stream with I/U/D operations
# - Silver: Deduplicate to latest version, ignore delete operations
#
# Expected Behavior:
# - Insert (I): Add new record
# - Update (U): Replace existing record with newer version
# - Delete (D): IGNORED - record remains in Silver
#
name: cdc_state_scd1_delete_ignore
description: CDC to state entity with SCD1, delete operations ignored

bronze:
  system: {system}
  entity: {entity}
  source_type: file_csv
  source_path: "{source_path}"
  target_path: "s3://{bucket}/{prefix}/bronze/system={system}/entity={entity}/dt={run_date}/"
  load_pattern: cdc
  cdc_operation_column: op
  partition_by: []

silver:
  source_path: "s3://{bucket}/{prefix}/bronze/system={system}/entity={entity}/dt=*/*.parquet"
  target_path: "s3://{bucket}/{prefix}/silver/system={system}/entity={entity}/dt={run_date}/"
  natural_keys: [{natural_key}]
  change_timestamp: {change_timestamp}
  entity_kind: state
  history_mode: current_only
  delete_mode: ignore
  cdc_operation_column: op
