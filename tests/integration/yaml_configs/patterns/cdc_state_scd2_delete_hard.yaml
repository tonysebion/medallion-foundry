# yaml-language-server: $schema=../../../../pipelines/schema/pipeline.schema.json
#
# Pattern: CDC -> State Entity -> SCD Type 2 (full_history) -> Delete Mode: HARD_DELETE
# =====================================================================================
# Use Case: CDC feed with full history tracking, deletes remove all history
# - Bronze: CDC stream with I/U/D operations
# - Silver: Full SCD2 history with effective dates, deletes remove entire key history
#
# Expected Behavior:
# - Insert (I): Create initial version with effective_from, is_current=1
# - Update (U): Close previous version, create new version
# - Delete (D): REMOVE all history for this key from Silver
#
# Silver Columns Added:
# - effective_from: When this version became active
# - effective_to: When this version was superseded (NULL if current)
# - is_current: 1 if this is the active version, 0 otherwise
#
# WARNING: Hard delete in SCD2 context removes ALL history for the key,
# not just the current version. Use with caution for compliance reasons.
#
name: cdc_state_scd2_delete_hard
description: CDC to state entity with SCD2 full history, deletes remove all key history

bronze:
  system: {system}
  entity: {entity}
  source_type: file_csv
  source_path: "{source_path}"
  target_path: "s3://{bucket}/{prefix}/bronze/system={system}/entity={entity}/dt={run_date}/"
  load_pattern: cdc
  cdc_operation_column: op
  partition_by: []

silver:
  domain: "{system}"
  subject: "{entity}"
  source_path: "s3://{bucket}/{prefix}/bronze/system={system}/entity={entity}/dt=*/*.parquet"
  target_path: "s3://{bucket}/{prefix}/silver/domain={domain}/subject={subject}/dt={run_date}/"
  natural_keys: [{natural_key}]
  change_timestamp: {change_timestamp}
  entity_kind: state
  history_mode: full_history
  delete_mode: hard_delete
  cdc_operation_column: op
