environment: prod
domain: commerce

datasets:
  - name: orders_batch
    system: orders
    entity: orders_full

    bronze:
      enabled: true
      source_type: api
      connection_name: ORDERS_API_TOKEN
      source_query: /orders
      partition_column: batch_id                             # original config used batch folders
      options:
        load_pattern: current_history                       # Bronze lands both current + history artifacts
        api:
          base_url: https://api.example.com
          method: GET
          params:
            page_size: 1000
            include_inactive: false
          pagination:
            type: page
            page_param: page
            start_page: 1
            max_pages: 1000
          incremental:
            enabled: true
            cursor_field: updated_at
            cursor_param: updated_since
            initial_cursor_value: 2025-01-01T00:00:00Z

    silver:
      enabled: true

      entity_kind: state                                    # we need as-of answers for the order record
      history_mode: scd2
      delete_mode: tombstone_state
      schema_mode: allow_new_columns

      natural_keys:
        - order_id

      change_ts_column: updated_at

      attributes:
        - status
        - total_amount
        - owner_id

      partition_by:
        - effective_from_dt

  - name: invoices_delta
    system: billing
    entity: invoices

    bronze:
      enabled: true
      source_type: api
      connection_name: INVOICE_API_KEY
      source_query: /invoices
      partition_column: invoice_date
      options:
        load_pattern: cdc
        api:
          base_url: https://api.example.com
          method: GET

    silver:
      enabled: true

      entity_kind: event                                    # delta feed emits invoice adjustments
      input_mode: append_log
      delete_mode: ignore
      schema_mode: strict

      natural_keys:
        - invoice_id

      event_ts_column: invoice_date
      change_ts_column: invoice_date

      attributes:
        - customer_id
        - total_due
        - status

      partition_by:
        - invoice_date_dt
