environment: prod
domain: customers

datasets:
  - name: customer_snapshot
    system: customers_dw
    entity: customer_snapshot

    bronze:
      enabled: true
      source_type: db
      connection_name: CUSTOMER_DB_CONN
      source_query: |
        SELECT ClaimID, MemberID, ServiceDate, Amount, UpdatedAt
        FROM dbo.ClaimsHeader
        WHERE UpdatedAt >= :start_ts AND UpdatedAt < :end_ts
      partition_column: hour_bucket
      owner_team: claims-platform
      owner_contact: claims-platform@example.com
      options:
        load_pattern: current_history
        db:
          cursor_column: UpdatedAt
          cursor_state_path: ./state/customers.cursor
          cursor_type: datetime
        local_output_dir: ./output/customers
        max_rows_per_file: 500000
        parallel_workers: 6
        max_file_size_mb: 512

    silver:
      enabled: true

      entity_kind: state
      history_mode: scd2
      delete_mode: tombstone_state
      schema_mode: allow_new_columns

      natural_keys:
        - ClaimID

      change_ts_column: UpdatedAt

      attributes:
        - MemberID
        - ServiceDate
        - Amount

      partition_by:
        - effective_from_dt

      semantic_owner: claims-analytics
      semantic_contact: claims-analytics@example.com

  - name: claim_cdc
    system: claims_dw
    entity: claims_cdc

    bronze:
      enabled: true
      source_type: db
      connection_name: CLAIMS_DB_CONN_STR
      source_query: |
        SELECT ClaimID, Status, UpdatedAt
        FROM dbo.ClaimsDelta
      partition_column: load_dt
      options:
        load_pattern: cdc

    silver:
      enabled: true

      entity_kind: event
      input_mode: append_log
      delete_mode: tombstone_event
      schema_mode: strict

      natural_keys:
        - ClaimID

      event_ts_column: UpdatedAt
      change_ts_column: UpdatedAt

      attributes:
        - Status

      partition_by:
        - UpdatedAt_dt
