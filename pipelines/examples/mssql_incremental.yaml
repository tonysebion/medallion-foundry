# yaml-language-server: $schema=../schema/pipeline.schema.json
#
# Example Pipeline: MSSQL Incremental Load
# =========================================
# Demonstrates incremental loading from a SQL Server database with watermark tracking.
#
# This example shows:
# - Database extraction with MSSQL (source_type: database_mssql)
# - Incremental load pattern using watermarks (load_pattern: incremental)
# - Environment variable expansion for secrets (${DB_HOST} syntax)
# - SCD Type 1 curation
#
# Setup:
#   1. Set database environment variables:
#       export DB_HOST=your-server.database.windows.net
#       export DB_USER=your_username
#       export DB_PASSWORD=your_password
#
#   2. (Optional) For S3 output, set storage environment variables:
#       export AWS_ACCESS_KEY_ID=your_access_key
#       export AWS_SECRET_ACCESS_KEY=your_secret_key
#       export AWS_REGION=us-east-1
#
#   3. Ensure the database has an 'order_details' table with an 'UpdatedAt' column
#
# Test connectivity:
#   python -m pipelines test-connection sales_db --host $DB_HOST --database SalesDB
#
# Run:
#   python -m pipelines ./pipelines/examples/mssql_incremental.yaml --date 2025-01-15
#
# Dry run (validate configuration):
#   python -m pipelines ./pipelines/examples/mssql_incremental.yaml --date 2025-01-15 --dry-run
#
# Check connectivity:
#   python -m pipelines ./pipelines/examples/mssql_incremental.yaml --date 2025-01-15 --check

name: mssql_incremental
description: Incremental load from SQL Server with watermark tracking

bronze:
  system: sales_dw
  entity: order_details
  source_type: database_mssql

  # Database connection using environment variables
  host: ${DB_HOST}
  database: SalesDB

  # Custom query - use :watermark placeholder for incremental
  query: |
    SELECT
      OrderDetailID,
      OrderID,
      ProductID,
      Quantity,
      UnitPrice,
      Discount,
      UpdatedAt
    FROM Sales.OrderDetails
    WHERE UpdatedAt > :watermark
    ORDER BY UpdatedAt

  # Incremental load settings
  load_pattern: incremental
  incremental_column: UpdatedAt

  # Storage output location (optional - auto-generates ./bronze/system=sales_dw/entity=order_details/dt={run_date}/)
  # For AWS S3:
  # target_path: "s3://data-lake/bronze/sales_dw/order_details/dt={run_date}/"

silver:
  domain: sales_dw
  subject: order_details
  unique_columns: [OrderDetailID]
  last_updated_column: UpdatedAt
  # target_path auto-generates: ./silver/domain=sales_dw/subject=order_details/dt={run_date}/
  # For AWS S3:
  # target_path: "s3://data-lake/silver/domain=sales_dw/subject=order_details/dt={run_date}/"
  attributes:
    - OrderID
    - ProductID
    - Quantity
    - UnitPrice
    - Discount
