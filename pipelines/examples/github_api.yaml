# yaml-language-server: $schema=../schema/pipeline.schema.json
#
# Example Pipeline: GitHub API
# ============================
# Demonstrates REST API extraction with authentication and pagination.
#
# This example shows:
# - Bearer token authentication via environment variable
# - Page-based pagination
# - Rate limiting to respect API limits
#
# Setup:
#   1. Set your GitHub token:
#       export GITHUB_TOKEN="ghp_xxxxxxxxxxxx"
#
#   2. (Optional) For Azure ADLS output, set storage environment variables:
#       export AZURE_STORAGE_ACCOUNT="your_account"
#       export AZURE_STORAGE_KEY="your_key"
#
# Run:
#   python -m pipelines ./pipelines/examples/github_api.yaml --date 2025-01-15
#
# Dry run (validate without API calls):
#   python -m pipelines ./pipelines/examples/github_api.yaml --date 2025-01-15 --dry-run

name: github_api
description: Extract GitHub repository events with bearer auth and pagination

bronze:
  system: github
  entity: repo_events
  source_type: api_rest

  # API configuration
  base_url: https://api.github.com
  endpoint: /repos/anthropics/claude-code/events

  # Authentication - bearer token from environment variable
  auth:
    auth_type: bearer
    token: ${GITHUB_TOKEN}

  # Page-based pagination
  pagination:
    strategy: page
    page_size: 30
    page_param: page
    page_size_param: per_page
    max_pages: 3  # Limit for demo

  # Rate limiting - GitHub allows 5000 requests/hour for authenticated users
  requests_per_second: 1.0

  # Extra headers required by GitHub
  headers:
    Accept: application/vnd.github+json
    X-GitHub-Api-Version: "2022-11-28"

  # Request timeout
  timeout: 30.0

  # Storage output location (optional - auto-generates ./bronze/system=github/entity=repo_events/dt={run_date}/)
  # For Azure Data Lake Storage (ADLS):
  # target_path: "abfss://bronze@datalake.dfs.core.windows.net/github/repo_events/dt={run_date}/"

silver:
  natural_keys: [id]
  change_timestamp: created_at
  # target_path auto-generates: ./silver/system=github/entity=repo_events/dt={run_date}/
  # For Azure ADLS:
  # target_path: "abfss://silver@datalake.dfs.core.windows.net/github/repo_events/dt={run_date}/"
