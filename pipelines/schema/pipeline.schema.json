{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "$id": "https://bronze-foundry.io/schema/pipeline.json",
  "title": "Bronze-Foundry Pipeline Configuration",
  "description": "Schema for Bronze-Foundry YAML pipeline configuration files",
  "type": "object",
  "additionalProperties": false,
  "properties": {
    "extends": {
      "type": "string",
      "description": "Path to parent config file for inheritance. Child values override parent values.",
      "examples": ["./base_config.yaml", "../shared/database_defaults.yaml"]
    },
    "env_file": {
      "type": "string",
      "description": "Path to .env file to load before processing. Environment variables from this file will be available for ${VAR} substitution. Path is relative to the YAML config file.",
      "examples": ["./.env", "./.env.production", "../shared/.env"]
    },
    "name": {
      "type": "string",
      "description": "Optional pipeline name (defaults to filename)"
    },
    "description": {
      "type": "string",
      "description": "Description of what this pipeline does"
    },
    "bronze": {
      "$ref": "#/definitions/bronze"
    },
    "silver": {
      "$ref": "#/definitions/silver"
    }
  },
  "anyOf": [
    { "required": ["bronze"] },
    { "required": ["silver"] },
    { "required": ["extends"] }
  ],
  "definitions": {
    "s3_storage_options": {
      "type": "object",
      "description": "S3-compatible storage options (for Nutanix Objects, MinIO, etc.)",
      "properties": {
        "s3_endpoint_url": {
          "type": "string",
          "description": "Custom S3 endpoint URL for S3-compatible storage (Nutanix Objects, MinIO, LocalStack, etc.)",
          "examples": ["https://objects.nutanix.local:443", "http://localhost:9000"]
        },
        "s3_signature_version": {
          "type": "string",
          "description": "S3 signature version. Use 's3v4' for most S3-compatible storage.",
          "enum": ["s3v4", "s3"],
          "examples": ["s3v4"]
        },
        "s3_addressing_style": {
          "type": "string",
          "description": "S3 URL addressing style. Use 'path' for S3-compatible storage (Nutanix, MinIO). AWS S3 uses 'virtual' by default.",
          "enum": ["path", "virtual", "auto"],
          "examples": ["path"]
        },
        "s3_region": {
          "type": "string",
          "description": "AWS region or region identifier for S3-compatible storage",
          "default": "us-east-1",
          "examples": ["us-east-1", "us-west-2", "eu-west-1"]
        },
        "s3_verify_ssl": {
          "type": "boolean",
          "description": "Enable SSL certificate verification. Defaults to false for self-signed certificates (MinIO, Nutanix Objects, local development).",
          "default": false
        }
      }
    },
    "bronze": {
      "type": "object",
      "description": "Bronze layer configuration - raw data extraction",
      "additionalProperties": false,
      "required": ["system", "entity", "source_type"],
      "properties": {
        "system": {
          "type": "string",
          "description": "Source system name (e.g., 'salesforce', 'erp', 'legacy')",
          "examples": ["retail", "crm", "hr_db"]
        },
        "entity": {
          "type": "string",
          "description": "Table or endpoint name (e.g., 'customers', 'orders')",
          "examples": ["orders", "customers", "products"]
        },
        "source_type": {
          "type": "string",
          "description": "Type of data source",
          "enum": [
            "file_csv",
            "file_parquet",
            "file_space_delimited",
            "file_fixed_width",
            "file_json",
            "file_jsonl",
            "file_excel",
            "database_mssql",
            "database_postgres",
            "database_mysql",
            "database_db2",
            "api_rest"
          ]
        },
        "source_path": {
          "type": "string",
          "description": "Path to source file, connection string, or API URL. Use {run_date} for date substitution.",
          "examples": [
            "./data/orders_{run_date}.csv",
            "s3://bucket/data/*.parquet"
          ]
        },
        "target_path": {
          "type": "string",
          "description": "Where to write Bronze output. Defaults to ./bronze/system={system}/entity={entity}/dt={run_date}/",
          "examples": [
            "./bronze/system={system}/entity={entity}/dt={run_date}/",
            "s3://bucket/bronze/{system}/{entity}/"
          ]
        },
        "s3_endpoint_url": {
          "type": "string",
          "description": "Custom S3 endpoint URL for S3-compatible storage (Nutanix Objects, MinIO, LocalStack, etc.)",
          "examples": ["https://objects.nutanix.local:443", "http://localhost:9000"]
        },
        "s3_signature_version": {
          "type": "string",
          "description": "S3 signature version. Use 's3v4' for most S3-compatible storage.",
          "enum": ["s3v4", "s3"],
          "examples": ["s3v4"]
        },
        "s3_addressing_style": {
          "type": "string",
          "description": "S3 URL addressing style. Use 'path' for S3-compatible storage (Nutanix, MinIO). AWS S3 uses 'virtual' by default.",
          "enum": ["path", "virtual", "auto"],
          "examples": ["path"]
        },
        "s3_region": {
          "type": "string",
          "description": "AWS region or region identifier for S3-compatible storage",
          "default": "us-east-1",
          "examples": ["us-east-1", "us-west-2", "eu-west-1"]
        },
        "s3_verify_ssl": {
          "type": "boolean",
          "description": "Enable SSL certificate verification. Defaults to false for self-signed certificates (MinIO, Nutanix Objects, local development).",
          "default": false
        },
        "load_pattern": {
          "type": "string",
          "description": "How to load data from source. IMPORTANT: This affects which Silver models are compatible!\n\n- full_snapshot: Extract ALL records each run. Each Bronze partition contains a complete snapshot. Use with Silver model: periodic_snapshot.\n\n- incremental: Extract only NEW/CHANGED records since last run (requires watermark_column). Bronze partitions are additive. Use with Silver models: full_merge_dedupe, scd_type_2, event_log.\n\n- cdc: Change Data Capture with Insert/Update/Delete markers (requires cdc_operation_column). Use with Silver models: cdc_current, cdc_history, etc.\n\nSee docs/MODEL_SELECTION.md for detailed guidance.",
          "enum": ["full_snapshot", "incremental", "incremental_append", "cdc"],
          "default": "full_snapshot"
        },
        "input_mode": {
          "type": "string",
          "description": "How Silver should interpret Bronze partitions. 'replace_daily' means each partition is a complete snapshot (Silver reads latest). 'append_log' means partitions are additive (Silver unions all partitions).",
          "enum": ["replace_daily", "append_log"]
        },
        "cdc_options": {
          "type": "object",
          "description": "CDC (Change Data Capture) options. Required when load_pattern is 'cdc'.",
          "properties": {
            "operation_column": {
              "type": "string",
              "description": "Column containing operation codes (I/U/D)",
              "examples": ["op", "operation", "_op", "__op"]
            },
            "insert_code": {
              "type": "string",
              "description": "Value indicating an Insert operation",
              "default": "I",
              "examples": ["I", "INSERT", "c", "create"]
            },
            "update_code": {
              "type": "string",
              "description": "Value indicating an Update operation",
              "default": "U",
              "examples": ["U", "UPDATE", "u", "update"]
            },
            "delete_code": {
              "type": "string",
              "description": "Value indicating a Delete operation",
              "default": "D",
              "examples": ["D", "DELETE", "d", "delete"]
            }
          },
          "required": ["operation_column"]
        },
        "watermark_column": {
          "type": "string",
          "description": "Column to use for incremental loads (required if load_pattern is incremental)",
          "examples": ["updated_at", "modified_date", "LastModified"]
        },
        "watermark_source": {
          "type": "string",
          "description": "Where to read watermark state. 'destination' (default) reads from Bronze _metadata.json in the target location (S3, ADLS, or local). 'local' reads from .state/ directory. 'auto' tries destination first, then local.",
          "enum": ["destination", "local", "auto"],
          "default": "destination"
        },
        "connection": {
          "type": "string",
          "description": "Named connection for reuse across multiple entities",
          "examples": ["crm_prod", "warehouse_readonly"]
        },
        "host": {
          "type": "string",
          "description": "Database host or environment variable like ${DB_HOST}",
          "examples": ["${DB_HOST}", "server.database.com"]
        },
        "database": {
          "type": "string",
          "description": "Database name",
          "examples": ["SalesDB", "analytics_warehouse"]
        },
        "query": {
          "type": "string",
          "description": "Custom SQL query (optional - defaults to SELECT * FROM entity)",
          "examples": ["SELECT * FROM Customers WHERE active = 1", "SELECT id, name, updated_at FROM orders"]
        },
        "chunk_size": {
          "type": "integer",
          "description": "Number of rows per chunk for large data (null = load all at once)",
          "minimum": 1000,
          "examples": [100000, 500000]
        },
        "full_refresh_days": {
          "type": "integer",
          "description": "Force full refresh every N days (null = never auto-refresh)",
          "minimum": 1,
          "examples": [7, 30]
        },
        "partition_by": {
          "type": "array",
          "items": { "type": "string" },
          "description": "Columns to partition output by",
          "default": ["_load_date"]
        },
        "write_checksums": {
          "type": "boolean",
          "description": "Write _checksums.json for data integrity verification",
          "default": true
        },
        "write_metadata": {
          "type": "boolean",
          "description": "Write _metadata.json for lineage and PolyBase DDL generation",
          "default": true
        },
        "options": {
          "type": "object",
          "description": "Source-specific options",
          "additionalProperties": true,
          "properties": {
            "csv_options": {
              "type": "object",
              "description": "Options for CSV parsing",
              "properties": {
                "delimiter": { "type": "string" },
                "header": { "type": "boolean" },
                "skip_rows": { "type": "integer" }
              }
            },
            "sheet": {
              "type": ["string", "integer"],
              "description": "Excel sheet name or index (for file_excel)"
            },
            "data_path": {
              "type": "string",
              "description": "Dot-notation path to navigate nested JSON (for file_json)",
              "examples": ["response.data.items", "records"]
            },
            "flatten": {
              "type": "boolean",
              "description": "Flatten nested JSON structures",
              "default": false
            },
            "widths": {
              "type": "array",
              "items": { "type": "integer" },
              "description": "Column widths for fixed-width files"
            },
            "columns": {
              "type": "array",
              "items": { "type": "string" },
              "description": "Column names for fixed-width or space-delimited files"
            },
            "s3_signature_version": {
              "type": "string",
              "description": "S3 signature version for S3-compatible storage (Nutanix Objects, MinIO, etc.)",
              "enum": ["s3v4", "s3"],
              "examples": ["s3v4"]
            },
            "s3_addressing_style": {
              "type": "string",
              "description": "S3 URL addressing style. Use 'path' for most S3-compatible storage.",
              "enum": ["path", "virtual", "auto"],
              "examples": ["path"]
            },
            "s3_verify_ssl": {
              "type": "boolean",
              "description": "Enable SSL certificate verification. Defaults to false for self-signed certificates.",
              "default": false
            },
            "record_type_position": {
              "type": "array",
              "items": {"type": "integer"},
              "minItems": 2,
              "maxItems": 2,
              "description": "Character positions [start, end) that identify record type (0-indexed). E.g., [0, 1] means first character. Use with record_types for multi-record files.",
              "examples": [[0, 1], [0, 2]]
            },
            "record_types": {
              "type": "array",
              "description": "Define how to parse each record type in a multi-record file (parent-child patterns like ABABBB)",
              "items": {
                "type": "object",
                "properties": {
                  "type": {
                    "type": "string",
                    "description": "Record type code found at record_type_position (e.g., 'A', 'B', 'H', 'D')"
                  },
                  "role": {
                    "type": "string",
                    "enum": ["parent", "child", "skip"],
                    "description": "parent=master record, child=detail record (belongs to preceding parent), skip=ignore"
                  },
                  "columns": {
                    "type": "array",
                    "items": {"type": "string"},
                    "description": "Column names for this record type"
                  },
                  "widths": {
                    "type": "array",
                    "items": {"type": "integer"},
                    "description": "Column widths (characters) AFTER the type indicator"
                  }
                },
                "required": ["type", "role"]
              }
            },
            "output_mode": {
              "type": "string",
              "enum": ["flatten", "parent_only", "child_only"],
              "default": "flatten",
              "description": "How to output parent-child records. flatten=repeat parent columns on each child row, parent_only=extract only parent records, child_only=extract only child records"
            }
          }
        },
        "base_url": {
          "type": "string",
          "description": "Base URL for REST API (e.g., 'https://api.example.com'). Required when source_type is api_rest.",
          "examples": ["https://api.example.com", "https://api.github.com"]
        },
        "endpoint": {
          "type": "string",
          "description": "API endpoint path (e.g., '/v1/orders'). Required when source_type is api_rest.",
          "examples": ["/v1/orders", "/users/{user}/repos", "/api/customers"]
        },
        "data_path": {
          "type": "string",
          "description": "Dot-notation path to records in API response (e.g., 'data.items')",
          "examples": ["data.items", "results", "response.records"]
        },
        "auth": {
          "type": "object",
          "description": "Authentication configuration for API requests",
          "properties": {
            "auth_type": {
              "type": "string",
              "description": "Authentication method",
              "enum": ["none", "bearer", "api_key", "basic"],
              "default": "none"
            },
            "token": {
              "type": "string",
              "description": "Bearer token (for auth_type=bearer). Use ${VAR_NAME} for environment variables.",
              "examples": ["${API_TOKEN}", "${GITHUB_TOKEN}"]
            },
            "api_key": {
              "type": "string",
              "description": "API key value (for auth_type=api_key). Use ${VAR_NAME} for environment variables.",
              "examples": ["${API_KEY}"]
            },
            "api_key_header": {
              "type": "string",
              "description": "Header name for API key (for auth_type=api_key)",
              "default": "X-API-Key",
              "examples": ["X-API-Key", "Authorization", "Api-Key"]
            },
            "username": {
              "type": "string",
              "description": "Username (for auth_type=basic). Use ${VAR_NAME} for environment variables.",
              "examples": ["${API_USERNAME}"]
            },
            "password": {
              "type": "string",
              "description": "Password (for auth_type=basic). Use ${VAR_NAME} for environment variables.",
              "examples": ["${API_PASSWORD}"]
            }
          }
        },
        "pagination": {
          "type": "object",
          "description": "Pagination configuration for API requests",
          "properties": {
            "strategy": {
              "type": "string",
              "description": "Pagination strategy",
              "enum": ["none", "offset", "page", "cursor"],
              "default": "none"
            },
            "page_size": {
              "type": "integer",
              "description": "Number of records per page",
              "default": 100,
              "minimum": 1,
              "examples": [50, 100, 1000]
            },
            "offset_param": {
              "type": "string",
              "description": "Query parameter name for offset (for strategy=offset)",
              "default": "offset",
              "examples": ["offset", "skip", "start"]
            },
            "limit_param": {
              "type": "string",
              "description": "Query parameter name for limit (for strategy=offset)",
              "default": "limit",
              "examples": ["limit", "count", "size"]
            },
            "page_param": {
              "type": "string",
              "description": "Query parameter name for page number (for strategy=page)",
              "default": "page",
              "examples": ["page", "pageNumber", "p"]
            },
            "page_size_param": {
              "type": "string",
              "description": "Query parameter name for page size (for strategy=page)",
              "default": "page_size",
              "examples": ["page_size", "pageSize", "per_page", "limit"]
            },
            "cursor_param": {
              "type": "string",
              "description": "Query parameter name to send cursor (for strategy=cursor)",
              "default": "cursor",
              "examples": ["cursor", "after", "next_token"]
            },
            "cursor_path": {
              "type": "string",
              "description": "Dot-notation path to next cursor in API response (for strategy=cursor)",
              "examples": ["meta.next_cursor", "pagination.next", "next_page_token"]
            },
            "max_pages": {
              "type": "integer",
              "description": "Maximum number of pages to fetch (null = no limit)",
              "minimum": 1,
              "examples": [10, 100]
            },
            "max_records": {
              "type": "integer",
              "description": "Maximum total records to fetch (null = no limit)",
              "minimum": 1,
              "examples": [1000, 10000]
            }
          }
        },
        "requests_per_second": {
          "type": "number",
          "description": "Rate limit for API requests (requests per second)",
          "minimum": 0.1,
          "examples": [1.0, 5.0, 10.0]
        },
        "timeout": {
          "type": "number",
          "description": "Request timeout in seconds",
          "default": 30.0,
          "minimum": 1,
          "examples": [30, 60, 120]
        },
        "max_retries": {
          "type": "integer",
          "description": "Maximum number of retry attempts for failed requests",
          "default": 3,
          "minimum": 0,
          "examples": [3, 5]
        },
        "headers": {
          "type": "object",
          "description": "Additional HTTP headers to send with API requests",
          "additionalProperties": { "type": "string" },
          "examples": [{"Accept": "application/json", "X-Custom-Header": "value"}]
        },
        "params": {
          "type": "object",
          "description": "Additional query parameters to send with API requests",
          "additionalProperties": { "type": "string" },
          "examples": [{"format": "json", "include_deleted": "false"}]
        },
        "path_params": {
          "type": "object",
          "description": "URL path parameter substitutions (e.g., {user} in /users/{user}/repos)",
          "additionalProperties": { "type": "string" },
          "examples": [{"user": "anthropics", "repo": "claude-code"}]
        },
        "watermark_param": {
          "type": "string",
          "description": "Query parameter name for watermark value (for incremental API loads)",
          "examples": ["since", "updated_after", "from_date"]
        }
      }
    },
    "silver": {
      "type": "object",
      "description": "Silver layer configuration - data curation",
      "additionalProperties": false,
      "required": ["domain", "subject"],
      "comment": "domain and subject are required. natural_keys and change_timestamp are required for all models except periodic_snapshot.",
      "properties": {
        "domain": {
          "type": "string",
          "description": "Business domain name (e.g., 'sales', 'finance', 'hr')",
          "examples": ["sales", "finance", "hr", "customer_success"]
        },
        "subject": {
          "type": "string",
          "description": "Subject area name (e.g., 'orders', 'customers', 'products')",
          "examples": ["orders", "customers", "products", "transactions"]
        },
        "natural_keys": {
          "oneOf": [
            { "type": "string" },
            { "type": "array", "items": { "type": "string" }, "minItems": 1 }
          ],
          "description": "Column(s) that uniquely identify a record",
          "examples": ["order_id", ["customer_id", "account_id"]]
        },
        "change_timestamp": {
          "type": "string",
          "description": "Column containing when the source record was last modified",
          "examples": ["updated_at", "modified_date", "LastModified"]
        },
        "source_path": {
          "type": "string",
          "description": "Path to Bronze data. Auto-wired from Bronze target if not specified.",
          "examples": [
            "./bronze/system=retail/entity=orders/dt={run_date}/*.parquet"
          ]
        },
        "target_path": {
          "type": "string",
          "description": "Where to write Silver output. Defaults to ./silver/domain={domain}/subject={subject}/",
          "examples": ["./silver/domain=sales/subject=orders/", "s3://bucket/silver/domain=sales/subject=orders/"]
        },
        "model": {
          "type": "string",
          "description": "Pre-built transformation pattern. MUST be compatible with Bronze load_pattern!\n\nFor full_snapshot Bronze:\n- periodic_snapshot: Simple refresh, reads only today's Bronze partition\n\nFor incremental Bronze:\n- full_merge_dedupe: Reads ALL Bronze partitions, dedupes to current state (SCD1)\n- scd_type_2: Reads ALL Bronze partitions, keeps full history with effective dates\n- event_log: Reads ALL Bronze partitions, keeps immutable events\n\nFor cdc Bronze:\n- cdc_current: CDC → current state (ignores deletes)\n- cdc_current_tombstone: CDC → current state with soft deletes\n- cdc_current_hard_delete: CDC → current state, removes deleted records\n- cdc_history: CDC → full history (ignores deletes)\n- cdc_history_tombstone: CDC → full history with soft deletes\n- cdc_history_hard_delete: CDC → full history, removes deleted records\n\nSee docs/MODEL_SELECTION.md for detailed guidance.",
          "enum": [
            "periodic_snapshot",
            "full_merge_dedupe",
            "incremental_merge",
            "scd_type_2",
            "event_log",
            "cdc_current",
            "cdc_current_tombstone",
            "cdc_current_hard_delete",
            "cdc_history",
            "cdc_history_tombstone",
            "cdc_history_hard_delete"
          ]
        },
        "entity_kind": {
          "type": "string",
          "description": "What kind of entity this represents",
          "enum": ["state", "event"],
          "default": "state"
        },
        "history_mode": {
          "type": "string",
          "description": "How to handle historical changes. 'current_only' (SCD1) or 'full_history' (SCD2)",
          "enum": ["current_only", "scd1", "full_history", "scd2"],
          "default": "current_only"
        },
        "input_mode": {
          "type": "string",
          "description": "How to interpret Bronze partitions. Usually auto-wired from Bronze layer.",
          "enum": ["replace_daily", "append_log"]
        },
        "delete_mode": {
          "type": "string",
          "description": "How to handle Delete operations in CDC data. 'ignore' filters out deletes, 'tombstone' keeps records with _deleted=true, 'hard_delete' removes records from Silver.",
          "enum": ["ignore", "tombstone", "hard_delete"],
          "default": "ignore"
        },
        "attributes": {
          "type": "array",
          "items": { "type": "string" },
          "description": "Columns to include (null = all columns). Cannot be used with exclude_columns."
        },
        "exclude_columns": {
          "type": "array",
          "items": { "type": "string" },
          "description": "Columns to exclude (null = none). Cannot be used with attributes."
        },
        "column_mapping": {
          "type": "object",
          "additionalProperties": { "type": "string" },
          "description": "Rename columns from Bronze to Silver. Keys are original column names, values are new names.",
          "examples": [
            { "ORDER_ID": "order_id", "CUST_NBR": "customer_number" },
            { "LastModified": "updated_at" }
          ]
        },
        "partition_by": {
          "type": "array",
          "items": { "type": "string" },
          "description": "Columns to partition output by (optional)"
        },
        "output_formats": {
          "type": "array",
          "items": {
            "type": "string",
            "enum": ["parquet", "csv"]
          },
          "description": "Output file formats",
          "default": ["parquet"]
        },
        "parquet_compression": {
          "type": "string",
          "description": "Compression codec for Parquet files",
          "enum": ["snappy", "gzip", "zstd", "lz4", "none"],
          "default": "snappy"
        },
        "validate_source": {
          "type": "string",
          "description": "How to validate Bronze source checksums",
          "enum": ["skip", "warn", "strict"],
          "default": "skip"
        },
        "s3_endpoint_url": {
          "type": "string",
          "description": "Custom S3 endpoint URL for S3-compatible storage (Nutanix Objects, MinIO, LocalStack, etc.). Auto-wired from Bronze if not specified.",
          "examples": ["https://objects.nutanix.local:443", "http://localhost:9000"]
        },
        "s3_signature_version": {
          "type": "string",
          "description": "S3 signature version. Use 's3v4' for most S3-compatible storage. Auto-wired from Bronze if not specified.",
          "enum": ["s3v4", "s3"],
          "examples": ["s3v4"]
        },
        "s3_addressing_style": {
          "type": "string",
          "description": "S3 URL addressing style. Use 'path' for S3-compatible storage (Nutanix, MinIO). Auto-wired from Bronze if not specified.",
          "enum": ["path", "virtual", "auto"],
          "examples": ["path"]
        },
        "s3_region": {
          "type": "string",
          "description": "AWS region or region identifier for S3-compatible storage. Auto-wired from Bronze if not specified.",
          "default": "us-east-1",
          "examples": ["us-east-1", "us-west-2", "eu-west-1"]
        },
        "s3_verify_ssl": {
          "type": "boolean",
          "description": "Enable SSL certificate verification. Defaults to false for self-signed certificates. Auto-wired from Bronze if not specified.",
          "default": false
        }
      },
      "allOf": [
        {
          "if": {
            "properties": {
              "model": {
                "enum": [
                  "full_merge_dedupe",
                  "incremental_merge",
                  "scd_type_2",
                  "event_log",
                  "cdc_current",
                  "cdc_current_tombstone",
                  "cdc_current_hard_delete",
                  "cdc_history",
                  "cdc_history_tombstone",
                  "cdc_history_hard_delete"
                ]
              }
            },
            "required": ["model"]
          },
          "then": {
            "required": ["natural_keys", "change_timestamp"]
          }
        },
        {
          "if": {
            "not": {
              "required": ["model"]
            }
          },
          "then": {
            "required": ["natural_keys", "change_timestamp"]
          }
        }
      ]
    }
  }
}
